<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
<link rel="stylesheet" type="text/css" href="topcat.css" title="Style">
</head>
<body>


<h3>Expression Syntax</h3>

<p>The expressions used to define 
<a href="synthetic.html">Synthetic Columns</a> and some 
<a href="subsets.html">Row Subsets</a> are actually expressions in 
the Java language, which are compiled into Java bytecode before
evaluation.  However, this does not mean that you need to be a 
Java programmer to write them.  The syntax is pretty similar to C,
but even if you're not a C programmer it should be obvious how to
do a lot of things.

<p>The following explanation gives
some guidance and examples for writing these expressions.
Unfortunately a complete tutorial on writing Java expressions is beyond
the scope of this document, but it should provide enough information
for even a novice to write useful expressions.

<p>If the functions described in this section are not sufficient,
or it's unwieldy to express your function in one line of code,
you can add new functions by writing your own classes.
See the following section on 
<a href="methods.html">extending the expression language</a>.

<h4>Referencing cell values</h4>

<p>To create a useful expression for a cell in a column, you will
have to refer to other cells in different columns of the same table row.
You can do this in two ways:
<dl>
<dt>By Name
<dd>The Name of the column may be used if it is unique (no other column in
    the table has the same name) and if it has a suitable form.
    This means that it must have the form of a Java variable - basically
    starting with a letter and continuuing with 
    letters or numbers.  In particular it cannot have any spaces in it.
    The underscore and currency symbols count as
    letters for this purpose.
    Column names are treated case-insensitively.

<dt>By $ID
<dd>The "$ID" identifier of the column may always be used to refer to it.
    This is just a "$" sign followed by a unique integer assigned by the
    viewer to each column when it is first encountered.
    You can find out the $ID identifier by looking in the 
    <a href="colinfo.html">Column Metadata Window</a>.
</dl>

<p>There is a special column whose name is "Index" and whose ID is "$0".
The value of this is the same as the row number in the unsorted table 
(the grey numbers on the left of the grid in the main browser window).

<p>The value of the variables so referenced will be a primitive
(boolean, byte, short, char, int, long, float, double) if the 
column contains one of the corresponding types.  Otherwise it will
be an Object of the type held by the column.

<h4>Referencing Row Subset flags</h4>

<p>If you have any Row Subsets defined you can also access the value
of the boolean (true/false) flag indicating whether the current row
is in each subset.  Again there are two ways of doing this:
<dl>
<dt>By Name
<dd>The name assigned to the subset when it was created can be used
    if it is unique and if it has a suitable form.  The same comments
    apply as to column names above.

<dt>By #ID
<dd>The "#ID" identifier of the subset may always be used to refer to it.
    As for the "$ID" identifier for columns above, this is a unique
    index preceded by a special symbol, "#".
</dl>
In either case, the value will be a boolean value; these can be useful
in conjunction with the ternary "<tt>?&nbsp;:</tt>" operator or 
when combining existing subsets using logical operators to create
a new subset.

<h4>Null values</h4>

<p>Without taking any special steps, if a null value (blank cell) 
is encountered
in evaluating an expression (usually because one of the columns
it relies on has a null value in the row in question) then the
result of the expression is also null.

<p>It is possible to exercise more control than this, but it
requires a little bit of care,
because the expressions work in terms of primitive values
(numeric or boolean ones) which don't in general have a defined null
value.  The name "null" in expressions gives you the java <tt>null</tt>
reference, but this cannot be matched against a primitive value
or used as the return value of a primitive expression.

<p>For most purposes, the following two tips should enable you to 
work with null values:

<dl>
<dt>Testing for null:
<dd>To test whether a column contains a null value, prepend the 
    string "NULL_" (use upper case) to the column name or $ID.  This 
    will yield a boolean value which is true if the column contains
    a blank or a floating point NaN (not-a-number) value, 
    and false otherwise.

<dt>Returning null:
<dd>To return a null value from a numeric expression, use the name "NULL" 
    (upper case).  To return a null value from a non-primitive expression
    (e.g. a String column) use the name "null" (lower case).
</dl>

Null values are often used in conjunction with the ternary conditional 
operator, "?:"; the expression
<pre>
   test ? tval : fval
</pre>
returns the value <tt>tval</tt> if the boolean expression <tt>test</tt>
evaluates true, or <tt>fval</tt> if <tt>test</tt> evaluates false.
See the examples below.


<h4>Operators</h4>

<p>The operators are pretty much the same as in C.
The common ones are:
<dl>
<dt>Arithmetic
<dd>
  <dl>
  <dt><tt>+</tt> (add)
  <dt><tt>-</tt> (subtract)
  <dt><tt>*</tt> (mutliply)
  <dt><tt>/</tt> (divide)
  <dt><tt>%</tt> (modulus)
  </dl>

<dt><strong>Logical</strong>
<dd>
  <dl>
  <dt><tt>!&nbsp;</tt> (not)
  <dt><tt>&amp;&amp;</tt> (and)
  <dt><tt>||</tt> (or)
  <dt><tt>==</tt> (identity)
  <dt><tt>!=</tt> (non-identity)
  <dt><tt>&lt;&nbsp;</tt> (less than)
  <dt><tt>&gt;&nbsp;</tt> (greater than)
  <dt><tt>&lt;=</tt> (less than or equal)
  <dt><tt>&gt;=</tt> (greater than or equal)
  </dl>

<dt>Other
<dd>
  <dl>
  <dt><tt>[]</tt> (array dereferencing)
  <dt><tt>?:</tt> (conditional switch)
  <dt><tt>instanceof</tt> (class membership)
  </dl>
</dl>

<h4>Functions</h4>

All the static methods of the <tt>Math</tt> class and some other classes
are available.  You can see a full listing of these in the
<a href="methods.html">Available Functions window</a>.
Some of the more useful ones are:
<dl>
<dt>Math static methods
<dd>
  <dl>
  <dt><tt>abs(x)</tt> (absolute value)
  <dt><tt>cos(x)</tt> (cosine)
  <dt><tt>sqrt(x)</tt> (square root)
  <dt><tt>max(a,b)</tt> (maximum)
  <dt><tt>pow(a,b)</tt> (exponentiation)
  <dt><tt>toRadians(deg)</tt> (angle conversion)
  </dl>
  (See <a href="http://java.sun.com/j2se/1.4.2/docs/api/java/lang/Math.html">Math class javadocs</a>
   for full list and details).

All the instance methods of the String class are provided, 
for example:
<dt><strong>String instance methods</strong>
<dd>
  <dl>
  <dt><tt>startsWith(s)</tt> (comparison)
  <dt><tt>equals(s)</tt> (equality)
  <dt><tt>equalsIgnoreCase(s)</tt> (case-insensitive)
  <dt><tt>matches(regex)</tt> (regular expression matching)
  </dl>
  (See <a href="http://java.sun.com/j2se/1.4.2/docs/api/java/lang/String.html">String class javadocs</a>
  for full list and details).
</dl>

<p>Technical note for Java programmers: the public static methods of
these classes are imported into the expression namespace, so unlike
java you should write "<tt>sqrt(x)</tt>" ant not "<tt>Math.sqrt(x)</tt>".
  

<h4>Examples</h4>

<p>Here are some examples for synthetic columns:
<dl>
<dt>Average
<dd><pre>
    ( first + second ) * 0.5
    </pre>

<dt>Outlier clipping
<dd><pre>
    min( 1000, max( value, 0 ) )
    </pre>

<dt>Converting a magic value to null
<dd><pre>
    jmag == 99.9 ? NULL : jmag
    </pre>

<dt>Converting a null value to a magic one
<dd><pre>
    NULL_jmag ? 99.9 : jmag
    </pre>
</dl>
</dl>

and here are some examples of boolean expressions that could be used
to define Row Subsets (or to create boolean synthetic columns):
<dl>
<dt>Within a circle
<dd><pre>
    sqrt( pow($2,2) + pow($3,2) ) &lt; 0.01
    </pre>

<dt>String matching
<dd><pre>
    CONSTELLATION.equalsIgnoreCase( "cygnus" )
    </pre>

<dt>Combining subsets
<dd><pre>
    ( #1 && #2 ) && ! #3
    </pre>

<dt>Test for non-blank value
<dd><pre>
    ! NULL_ellipticity
    </pre>
</dl>

</body>
</html>
